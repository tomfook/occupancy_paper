---
title: "General Framework for Seat Occupancy Expectation"
author:
  name: "Fukumoto Tomoya"
  affiliation: "Operation Planning"
date: "2018-08-20"
output: html_document
#abstract: "hogehoge is important issue for us. We established a mathematical framework to expect seat occupancy of ride attractions. Our model is based on Markov chain model. Since our model is general, we can aplly to any attraction."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Introduction
One of the most important issues in theme park operation is increasing guest counts at attractions.
Since guest counts can be decomposed into dispatch count and seat occupancy, we focus on these two factors separately.
The aim of this study is to establish a mathematical framework to predict seat occupancy of ride attractions.
We revealed that seat occupancy can be derived from statistics of group sizes of arriving guests, the configuration of seats, queue formation, and grouping strategy.
This framework will help us to optimize queue formation and grouping strategy.
Because the model is general, that is, not dependent on any specific attraction, the framework can be applied to any attraction.

## Modeling and Framework
### Problem
For ride attractions, grouping operation is deeply related to seat occupancy.
Attraction crew members form a group to dispatch a vehicle from arriving guests without breaking up friend groups.
Such crew members are called groupers.
Guests arrive continuously.
Groupers guide guests who arrived earlier first.
Groupers cannot choose or predict the size of the next friend group to arrive.

Almost all vehicle seat arrangements are designed in a rectangle pattern.
This means seats are arranged in rows, with multiple rows lined up.
The grouping operation involves seating guest groups in the same row.
Friend groups must remain together in the same row and sit consecutively.

The grouping problem is how to maximize guest experience while filling seats with guest groups.
Groupers ask the size of each group and select a row to guide them to.
The grouping strategy is to select an optimal row when a group of a given size arrives.

Therefore, there exists an upper bound on seat occupancy for each attractions.

The upper bound depends on statistics of group sizes of arriving guests and the pattern of seat configuration.
If we have a knowledge of the upper bound of an attraction, we can evaluate the efficiency of its grouping operation and whether the seat occupancy can improve.

### Mathematical Modeling
Our problem can be handled as a state-action-reward model.

- **state**:  the seats pattern filled by guests
- **action**: decision which row to seat arriving guests and whether to dispatch a vehicle
- **reward**: the number of guests who take a seat when a vehicle is dispatched

To handle this model, we define several variables for state and transition

- the size of $i$-th arriving group is a random variable $x_i \in \mathbb N$.
- the seats filled pattern after the $i$th group has seats $s_i$.
- the set of pattern of seats filled $\sigma \in \Sigma$.

After a vehicle is dispatched, a new vacant vehicle will come.
This means the state will be initialized as $\sigma_0$.

<!--a1[label = '<I>s@_{i}</I>', shape = circle];-->

```{r markov, fig.width = 5, fig.height = 2}
library(DiagrammeR)
grViz(
  "digraph dot{
    graph[
      rankdir = LR,
      label = 'Fig.1: State, Action, and Transition',
      fontsize = 15
    ]
    node[
      fixedsize = false
    ]
      a1[label = '<I>s</I>@_{<I>i</I>}=<I>&sigma;</I>', shape = circle];
      a2[label = 'Which row\n to seat?', shape = square];
    edge[label = '<I>x@_{i}</I>'] a1 -> a2 ;
      a3[label = 'Dispatch\n or not?', shape = square];
    edge[label = ''] a2 -> a3;
      a4[label = '<I>s</I>@_{<I>i</I>+1}=<I>&sigma;</I>&prime;', shape = circle];
      edge[label = ''] a3 -> a4;

}
  "
)
```

We assume that the situation is stationary.
The assumption means the probability that a group of size $k$ arrives is independent of time $P[x_i=k]=p_k$ .

## Simple case: Markov chain
If the seat layout is a single row, we have only two options: seat the group or dispatch the vehicle, since we cannot choose which specific seats to provide.
In that case, our model can be treated as a simple **Markov chain model**.
The expected seat occupancy can be calculated from the transition probability $P[x_i=k]=p_k$. 
To do this, we need to derive the state probability distribution $P[a_i=n]$ from $p_k$, since the expected occupancy can be easily calculated from $p_k$ and $P[a_i=n]$.
This expectation value should be the upper bound of seat occupancy.

### Steps to solve the problem
We solve this in three steps:

1. Construct a transition matrix based on the number of seats and the distribution of group sizes.
2. Identify the stationary state.
3. Calculate the expected seat occupancy from the stationary probability distribution.

#### Setting a transition matrix
Suppose a group of size $k$ arrives.
If the number of empty seats is greater than or equal to $k$, the group is seated.
If it is less than $k$, the crew dispatches the current vehicle and the group is seated in a new vehicle.

- If $s_i\geq x_i$ then $s_{i+1}=s_i+x_i$ 
- If $s_i>x_i$ then $s_{i+1}=x_i$

This means the state probability can be described by the previous state and arrival distribution.
Since the arrival distribution is independent of the current state, the transition probabilities are
$$
\begin{eqnarray}
T_{jk}&=&P[s_{i+1}=k|s_{i}=j]\\
  &=&\begin{cases}p_{j-k}P[s_{i}=j]&(j-k>0)\\ p_{k}P[s_{i}=j]&(j-k\leq0)\end{cases}\\
\end{eqnarray}
$$
We call such a matrix the **transition matrix**.

We show an example with the simplest case: two seats.
In this case, the seat occupancy can be in states $s_i=0, 1, 2$.


Markov state and transition in this situation will be described in Fig.2.
```{r twoseattransition, fig.width = 4}
grViz("
  digraph dot{
    graph[
      rankdir = LR,
      label = 'Fig.2: The Simplest Case(two seats). \nRed means dispatch',
      fontsize = 10,
      layout = neato,
      ordering = out,
    ];
    node[
      shape = circle,
      fixedsize = true
    ];
    a0[label = '0'];
    a1[label = '1'];
    a2[label = '2'];
    a0 -> a1[label = '<I>p</I>@_{1}'];
    a0 -> a2[label = '<I>p</I>@_{2}'];
    a1 -> a2[label = '<I>p</I>@_{1}'];
    a1 -> a2[label = '<I>p</I>@_{2}', color = red];
    a2 -> a1[label = '<I>p</I>@_{1}', color = red];
    a2 -> a2[label = '<I>p</I>@_{2}', color = red];
  }
#  digraph dot{
#    graph[
#      rankdir = LR,
#      label = 'Fig.2: Simplest Case(two seats). \nRed means dispatch',
#      fontsize = 10,
#      layout = dot,
#      ordering = out,
#    ];
#    node[
#      shape = circle,
#      fixedsize = true
#    ];
#    a0[label = '<I>a@_{i}</I>=0'];
#    a1[label = '<I>a@_{i}</I>=1'];
#    a2[label = '<I>a@_{i}</I>=2'];
#    b0[label = '<I>a@_{i+1}</I>=0'];
#    b1[label = '<I>a@_{i+1}</I>=1'];
#    b2[label = '<I>a@_{i+1}</I>=2'];
#    a0 -> b1[label = '<I>p</I>@_{1}'];
#    a0 -> b2[label = '<I>p</I>@_{2}'];
#    a1 -> b2[label = '<I>p</I>@_{1}'];
#    a1 -> b2[label = '<I>p</I>@_{2}', color = red];
#    a2 -> b2[label = '<I>p</I>@_{2}', color = red];
#    a2 -> b1[label = '<I>p</I>@_{1}', color = red];
#    {rank = min; a0;a1;a2;}
#    {rank = max; b0;b1;b2;}
#  } 
")
```
As an element $T_{jk}$ means probability to move from state $s_i=j$ to state $s_{i+1}=k$, we can define transition matrix
$$
T=\begin{pmatrix}
  0 & p_1 & p_2 \\
  0 & 0 & 1\\
  0 & p_1 & p_2
  \end{pmatrix},
$$
since $p_1+p_2=1$.  

#### Stationary State
If state probability is given by $A_i$ then next step $A_{i+1}=A_iT$.
We can calculate state probability in each step.
If we continue to calculate and state converge, state probability should be a sufficient equation
$$
A=AT
$$
This means stationary state is eigenvector corresponding eigenvalues 1 of $T$.
So we obtain stationary state by calculating eigenvector of $T$.

#### Expectation value of seat occupancy

## Actual setting: one line of four seats
As an example, we calculate seat occupancy in a situation of

- one line of seats
- four seats in the line

This situation matches the seats configuration of Harry Potter and the Forbidden Journey.

### Transition Matrix 
With only a single row, guest must be seated in arrival order.
Therefore, the grouping startegy is determined automatically.

$$
T=\begin{pmatrix}
  p_4 & p_3+p_4& p_2+p_4&p_1+p_4\\
  p_1&0&0&0\\
  p_2&p_1&0&p_2\\
  p_3&p_2&p_1+p_3&p_3
  \end{pmatrix}
$$
 
### Single Queue   

To approach this problem, we assume $p_1=p, p_2=p_3=p_4=(1-p)/3$.
This is the simplest model with only two parameters: the probability of single guests and the distribution of group sizes.
We assume that each group size (2, 3, 4) has equal probability.
Then by an equation $Tx=x$, we can obtain the stationary state
$$
x = \frac{1}{6(p+1)(2p^2-p+2)}\begin{pmatrix}
  2p^2+2p+5\\
  2p^3+2p^2+5p\\
  4p^3+4p^2-2p+3\\
  6p^3-2p^2+p+4
  \end{pmatrix}
$$

The dispatch probability is
$$
p_D=\frac{-28p^4+24p^3+6p^2-8p+33}{18(p+1)(2p^2-p+2)}
$$

The expected occupancy rate is
$$
\begin{eqnarray}
\mathrm E[Ocp] &=& \frac{1}{p_D}\frac{3-2p}{4}\\
  &=& \frac{9(p+1)(3-2p)(2p^2-p+2)}{2(-28p^4+24p^3+6p^2-8p+33)}
  \end{eqnarray}
$$


We substitute concrete values to the parameters.
In case of $p=1/20$, 
$$
\pi = \begin{pmatrix}\pi_0\\\pi_1\\\pi_2\\\pi_3\end{pmatrix}= \begin{pmatrix}0.415\\ 0.021\\ 0.236\\ 0.329\end{pmatrix}
$$
and the dispatch transition matrix is
$$
T_D = \begin{pmatrix}
  p_4&p_3+2p_4&p_2+2p_4&p_1+2p_4\\
  0&0&0&0\\
  0&0&0&p_2\\
  0&0&p_3&p_3
  \end{pmatrix}
$$
thus
$$
p_D = \mathbf 1^\mathrm{T}T\pi=0.8827
$$
Therefore, the expected occupancy is
$$
\mathrm E[Ocp] = \begin{pmatrix}
  p_4&p_3+\frac54p_4&p_2+\frac12p_3+\frac32p_4&p_1+\frac34p_2+\frac34p_3+\frac74p_4\\
\end{pmatrix}\begin{pmatrix}\pi_0\\\pi_1\\\pi_2\\\pi_3\end{pmatrix}
  =0.8213
$$

### With Single-Rider Queue
If a single-rider queue is available, the parameters should be modified as
$$
p_1=0, p_2=p_3=p_4=1/3
$$
Then we can obtain the stationary state as
$$
\pi=\begin{pmatrix}0.417\\0\\0.25\\0.333\end{pmatrix}
$$
Using this, we can easily calculate the dispatch probability
$$
D = 0.9167
$$
and the expectation of occupancy
$$
\mathrm E[Ocp]=0.818
$$
Finally, we adjust for the single-rider effect: 
$$
\mathrm E[Ocp_S]=\mathrm E[Ocp](1+p_s)=0.859
$$
where $p_s$ is a single-rider proportion, assumed by 0.05.

### Pre-grouping
We pre-group guests by merging groups of size 2 or 4 together, keeping groups of size 3 separate.

If group size is only 3, expected occupancy will be 0.75.

In case of group size 2 or 4, we set each probability as $p, 1-p$.

Transition matrix
$$
T = \begin{pmatrix} 1-p&1\\p&0\end{pmatrix}
$$

Stationary state
$$
\pi = \frac{1}{1+p}\begin{pmatrix}1\\p\end{pmatrix}
$$

Expected Dispatch
$$
\mathrm E[D]=\frac{-p^2+p+1}{p+1}
$$

The expected Occupancy
$$
\mathrm E[Ocp]=\frac{p^2-p+2}{2(-p^2+p+1)}
$$
In case $p=1/2$, expected occupancy is minimum 0.9.


## Conclusion
- change 
