---
title: "General Framework for Seat Occupancy Expectation"
author:
  name: "Fukumoto Tomoya"
  affiliation: "Operation Planning"
date: "2018-08-20"
output: html_document
#abstract: "hogehoge is important issue for us. We established a mathematical framework to expect seat occupancy of ride attractions. Our model is based on Markov chain model. Since our model is general, we can aplly to any attraction."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(DiagrammeR)
library(ggplot2)
```

## Introduction
One of the most important issue for theme park operation is raising guestcounts of attractions.
Since guestcounts can be decomposed by dispatch count and seat occupancy, we separately focus on these two numbers.
The aim of this study is to establish a mathematical framework to expect seat occupancy of ride attractions.
We revealed that seat occupancy is derivable by statistics of group size of arrival guests, the configuration of seats, queue formation and grouping strategy.
This framework will help us to optimize queue formation and grouping strategy.
Because the model is general, that is, the model is not dependent on any actual attraction, the framework can be applied to any attractions.

## Modeling and Framework
### Problem
For ride attractions, grouping operation is deeply related to seat occupancy.
Attraction crew forms a group to dispatch a vehicle from arrival guests not to break a friend group.
That crew is called a grouper.
Guests come again and again.
A grouper guides former arrival guest first.
Grouper can not choose a size of friend group to come next and even expect it.

Almost all seat arrangement of vehicle is designed to be a rectangle pattern.
This means that seats are set in a row, and one or more rows are line up.
Grouping operation is to gather people to have a seat in the same row.
And of course friend group should be in the same group and sit next to each other.

Grouping problem is how to maximize guest experience to fill seats with guest group.
Grouper ask a size of group and select a row to guide.
Grouping strategy is to select an optimal row when a size of group come.

Therefore there exists an upper bound of seat occupancy in each attractions.

The upper bound would depend on statistics of group size of arrival guest and a pattern of seats configuration.
If we have a knowledge of upper bound of an attraction, we can evaluate its efficiency of grouping operation and whether the seat occupancy can improve or not.

### Mathematical Modeling
Our problem can be handled as a state-action-reward model.

- **state**:  the seats pattern filled by guests
- **action**: decision which row to guide arrival guests and to dispatch a vehicle or not
- **reward**: the number of guests who take a seat when a vehicle is dispatched

To treat this model, we define a numbers of variables for state and transition

- the size of $i$th arrival group is a probability variable $x_i \in \mathbb N$.
- the seats filled pattern after the $i$th group has seats $s_i$.
- the set of pattern of seats filled $\sigma \in \Sigma$.

After a vehicle is dispatched, a new vacant vehicle will come.
This means the state will be initialized as $\sigma_0$.

```{r markov, fig.width = 5, fig.height = 2}
grViz(
  "digraph dot{
    graph[
      rankdir = LR,
      label = 'Fig.1: State, Action, and Transition',
      fontsize = 15
    ]
    node[
      fixedsize = false
    ]
      a1[label = '<I>s</I>@_{<I>i</I>}=<I>&sigma;</I>', shape = circle];
      a2[label = 'Which row\n to guid?', shape = square];
    edge[label = '<I>x@_{i}</I>'] a1 -> a2 ;
      a3[label = 'Dispatch\n or not?', shape = square];
    edge[label = ''] a2 -> a3;
      a4[label = '<I>s</I>@_{<I>i</I>+1}=<I>&sigma;</I>&prime;', shape = circle];
      edge[label = ''] a3 -> a4;

}
  "
)
```

We assume that the situation is stationary.
The assumption induces the probability that a size $k$ group arrives is independent on time $P[x_i=k]=p_k$ .

## Simple case: Markov chain
If the seat layout is one line, then our option is giving seats or dispatch a vehicle because we can not choose which seats we provide.
This means that statistics of a guest arrival directly gives the probability of transition from a state to another.
We can handle such problems as a simple Markov chain model.

In this case, the number of occupied seats describes the state completely,

$$
\sigma \in \Sigma = \{1,2,\ldots,N\}
$$

where $N$ is the number of seats in the line.
We can calculate the probability being each state $P[s_i=n]$ from $p_k$, and the expectation of seat occupancy from the state probabilities.
This expectation value should be the upper bound of seat occupancy.

### Steps to solve the problem
We 

1. Give a transition matrix
2. Identify the stationary state.
3. Calculate the expectation value of occupancy from stationary probability.

#### transition matrix
Suppose that a group sized $k$ has arrived.
In case the number of empty seats is greater than $k$, they will take their seats.
If it's less than $k$, the crew dispatch the vehicle and give them a new vacant vehicle.

- $s_i<x_i$ then $s_{i+1}=s_i+x_i$ 
- $s_i>x_i$ then $s_{i+1}=x_i$

Because arrival probability is independent on state, we can calculate probabilities from state j to k as
$$
\begin{eqnarray}
T_{jk}&=&P[s_{i+1}=k|s_{i}=j]\\
  &=&\begin{cases}p_{j-k}P[s_{i}=j]&(j-k>0)\\ p_{k}P[s_{i}=j]&(j-k\leq0)\end{cases}.\\
\end{eqnarray}
$$
And we call a matrix which elements are these probabilities as **transition matrix**.

We show an example in the simplest case, which has only two seats.
In this case, seat occupancy can take $s_i=0, 1, 2$.

Markov state and transition in this situation can be shown in Fig.2.
```{r twoseattransition, fig.width = 4}
grViz("
  digraph dot{
    graph[
      rankdir = LR,
      label = 'Fig.2: The Simplest Case(two seats). \nRed means dispatch',
      fontsize = 10,
      layout = neato,
      ordering = out,
    ];
    node[
      shape = circle,
      fixedsize = true
    ];
    a0[label = '0'];
    a1[label = '1'];
    a2[label = '2'];
    a0 -> a1[label = '<I>p</I>@_{1}'];
    a0 -> a2[label = '<I>p</I>@_{2}'];
    a1 -> a2[label = '<I>p</I>@_{1}'];
    a1 -> a2[label = '<I>p</I>@_{2}', color = red];
    a2 -> a1[label = '<I>p</I>@_{1}', color = red];
    a2 -> a2[label = '<I>p</I>@_{2}', color = red];
  }
  ")
```
In this case our transition matrix is
$$
T=\begin{pmatrix}
  0 & p_1 & p_2 \\
  0 & 0 & 1\\
  0 & p_1 & p_2
  \end{pmatrix},
$$
since $p_1+p_2=1$.  

#### Stationary State
If state probability is given by a vector $A_i=(P[s_i=0],P[s_i=1],P[s_i=2])$, then next step $A_{i+1}=A_iT$.
We can calculate a state probability in each step.
If the calculation converges, state probability satisfies an equation
$$
A=AT
$$
This probability vector is called a **stationary distribution**.
The stationary distribution is an eigenvector corresponding eigenvalues 1 of $T$.

We empirically know that it is very fast to approach the stationary distribution.
So we can expect we observe the states with the stationary distribution in most of the time.
This means that the expectation of seat occupancy from the stationary distribution is a reasonable estimation.

By easy calculation, we can get the stationary distribution as
$$
A = \left(0, \frac{p}{p+2}, \frac{2}{p+2}\right)
$$
where $p=p_1=1-p_2$.

#### Expectation value of seat occupancy
The expectation of seat occupancy can be described with the conditional probability
$$
\mathrm E\left[ \mathrm{ Seat Occupancy } | \mathrm{ Dispatch } \right] = \frac{\mathrm E[\mathrm{OccupancyWhenDispatch}]}{P[\mathrm{Dispatch}]}.
$$

The probability of dispatch is
$$
P[\mathrm{Dispatch}]=a_1p_2+a_2(p_1+p_2) = \frac{-p^2+p+2}{p+2}
$$

And the numerator is
$$
\mathrm{E}[\mathrm{OccupancyWhenDispatch}]=1\cdot a_1p_2 + 2\cdot a_2(p_1+p_2) = \frac{-p^2+p+4}{p+2}
$$

Thus our goal is
$$
\mathrm E\left[ \mathrm{ Seat Occupancy } | \mathrm { Dispatch } \right] = \frac{-p^2+p+4}{-p^2+p+2}.
$$

```{r simplest_occupancy}
p <- seq(0, 1, by = 0.01)
fun <- function(p) return((-p^2+p+4)/(-p^2+p+2))
df <- data.frame(p = p, seat_occupancy = fun(p))
ggplot(df) +
  geom_line(aes(p, seat_occupancy)) +
  scale_y_continuous(breaks = seq(1.85,2,by=0.05)) +
  labs(
       title = "Fig3. Seat Occupancy vs Arrival Probability of single guest",
       subtitle = "uncertainity reduces occupancy expectation",
       y = "Occupancy Expectation"
  )
```

We can see the expectation of seat occupancy has the greatest value 2 in $p=0,p=1$.
This is obvious because in the case the arrival group size is fixed with 1 or 2.
In the most uncertain case $p=1/2$ our expectation is the least $17/9\sim1.89$

We completely solved the problem.
Logically we could solve any other situation having one line seats in the same manner.
But it does not mean we can solve such problem easily.

## Actual setting: one line of four seats
As an example, we calculate seat occupancy in a situation of

- one line of seats
- four seats in the line

This situation matches the seats configuration of Harry Potter and the Forbidden Journey.

We 

### Transition Matrix 
If we make only one line, we have to group guests in arrival order.
Thus our grouping strategy can be decided automatically.
$$
T=\begin{pmatrix}
  p_4 & p_3+p_4& p_2+p_4&p_1+p_4\\
  p_1&0&0&0\\
  p_2&p_1&0&p_2\\
  p_3&p_2&p_1+p_3&p_3
  \end{pmatrix}
$$
 
### Single Queue   

To approach this problem, we assume $p_1=p, p_2=p_3=p_4=q/3$.
This is the simplest model which has only two parameters, single guest ratio and grouped guest.
And each group guests come to an attraction in the same possibility.
Then by an equation $Tx=x$, we can obtain the stationary state
$$
x = \frac{1}{6(p+1)(2p^2-p+2)}\begin{pmatrix}
  2p^2+2p+5\\
  2p^3+2p^2+5p\\
  4p^3+4p^2-2p+3\\
  6p^3-2p^2+p+4
  \end{pmatrix}
$$

The probability of dispatch
$$
p_D=\frac{-28p^4+24p^3+6p^2-8p+33}{18(p+1)(2p^2-p+2)}
$$

The expected occupancy
$$
\begin{eqnarray}
\mathrm E[Ocp] &=& \frac{1}{p_D}\frac{3-2p}{4}\\
  &=& \frac{9(p+1)(3-2p)(2p^2-p+2)}{2(-28p^4+24p^3+6p^2-8p+33)}
  \end{eqnarray}
$$


We substitute concrete values to the parameters.
In case of $p=1/20$, 
$$
\pi = \begin{pmatrix}\pi_0\\\pi_1\\\pi_2\\\pi_3\end{pmatrix}= \begin{pmatrix}0.415\\ 0.021\\ 0.236\\ 0.329\end{pmatrix}
$$
and dispatch transition is
$$
T_D = \begin{pmatrix}
  p_4&p_3+2p_4&p_2+2p_4&p_1+2p_4\\
  0&0&0&0\\
  0&0&0&p_2\\\
  0&0&p_3&p_3
  \end{pmatrix}
$$
thus
$$
p_D = \mathbf 1^\mathrm{T}T\pi=0.8827
$$
Then we obtain the expected occupancy is 
$$
\mathrm E[Ocp] = \begin{pmatrix}
  p_4&p_3+\frac54p_4&p_2+\frac12p_3+\frac32p_4&p_1+\frac34p_2+\frac34p_3+\frac74p_4\\
\end{pmatrix}\begin{pmatrix}\pi_0\\\pi_1\\\pi_2\\\pi_3\end{pmatrix}
  =0.8213
$$

### With Single-Rider Queue
If we have a single-rider queue, the parameters should be modified as
$$
p_1=0, p_2=p_3=p_4=1/3
$$
Then we can obtain the stationary state as
$$
\pi=\begin{pmatrix}0.417\\0\\0.25\\0.333\end{pmatrix}
$$
Using this, we can easily calculate the dispatch probability
$$
D = 0.9167
$$
and the expectation of occupancy
$$
\mathrm E[Ocp]=0.818
$$
Finally, we adjust a single-rider effect as 
$$
\mathrm E[Ocp_S]=\mathrm E[Ocp](1+p_s)=0.859
$$
where $p_s$ is a single-rider availability assumed by 0.05.

### Pre-grouping
- we separate guests by its group size (2,4) and 3 before grouping

If group size is only 3, expected occupancy will be 0.75.

In case of group size 2 or 4, we set each probability as $p, 1-p$.

Transition matrix
$$
T = \begin{pmatrix} 1-p&1\\p&0\end{pmatrix}
$$

Stationary state
$$
\pi = \frac{1}{1+p}\begin{pmatrix}1\\p\end{pmatrix}
$$

Expected Dispatch
$$
\mathrm E[D]=\frac{-p^2+p+1}{p+1}
$$

The expected Occupancy
$$
\mathrm E[Ocp]=\frac{p^2-p+2}{2(-p^2+p+1)}
$$
In case $p=1/2$, expected occupancy is minimum 0.9.


## Conclusion
- change 
