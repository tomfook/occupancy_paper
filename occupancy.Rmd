---
title: "General Framework for Seat Occupancy Expectation"
author:
  name: "Fukumoto Tomoya"
  affiliation: "Operation Planning"
date: "2018-08-20"
output: html_document
#abstract: "Maximizing seat occupancy is an important issue for theme park operations. We established a mathematical framework to predict seat occupancy of ride attractions. Our model is based on Markov chain theory. Since our model is general, we can apply it to any attraction."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Introduction
One of the most important issues in theme park operation is increasing guest counts at attractions.
Since guest counts can be decomposed into dispatch count and seat occupancy, we focus on these two factors separately.
The aim of this study is to establish a mathematical framework to predict seat occupancy of ride attractions.
We show that seat occupancy can be derived from statistics of group sizes of arriving guests, the configuration of seats, queue formation, and grouping strategy.
This framework will help us to optimize queue formation and grouping strategy.
Because the model is general, that is, not dependent on any specific attraction, the framework can be applied to any attraction.

## Modeling and Framework
### Problem
For ride attractions, grouping operation is deeply related to seat occupancy.
Attraction crew members organize arriving guests into groups for dispatch without separating friends who arrived together.
Such crew members are called groupers.
Guests arrive continuously.
Groupers guide guests who arrived earlier first.
Groupers cannot choose or predict the size of the next friend group to arrive.

Almost all vehicle seats are arranged in a rectangular pattern.
This means seats are arranged in rows, with multiple rows lined up.
The grouping operation involves seating guest groups in the same row.
Friend groups must remain together in the same row and sit consecutively.

The grouping problem is how to maximize guest experience while filling seats with guest groups.
Groupers ask the size of each group and select a row to guide them to.
The grouping strategy is to select an optimal row when a group of a given size arrives.

Therefore, there exists an upper bound on seat occupancy for each attraction.

The upper bound depends on statistics of group sizes of arriving guests and the pattern of seat configuration.
If we understand the upper bound for an attraction, we can evaluate the efficiency of its grouping operation and determine whether the seat occupancy can be improved.

### Mathematical Modeling
Our problem can be handled as a state-action-reward model.

- **state**:  the seats pattern filled by guests
- **action**: the decision regarding which row to assign to arriving guests and whether to dispatch a vehicle
- **reward**: the number of guests who take a seat when a vehicle is dispatched

To handle this model, we define several variables for state and transition:

- $n$: the number of seats in a row (for multi-row configurations, $n_i$ denotes seats in row $i$)
- $x_i \in \mathbb{N}$: the size of the $i$-th arriving group
- $\Sigma$: the set of all possible seat occupancy states
- $\sigma \in \Sigma$: a seat occupancy state (pattern representing which seats are filled)
- $s_i \in \Sigma$: the seat occupancy state after the $i$-th group has been seated

After a vehicle is dispatched, a new empty vehicle arrives.
This means the state returns to the initial state $\sigma_0$ (an empty vehicle).

<!--a1[label = '<I>s@_{i}</I>', shape = circle];-->

```{r markov, fig.width = 5, fig.height = 2}
library(DiagrammeR)
grViz(
  "digraph dot{
    graph[
      rankdir = LR,
      label = 'Fig.1: State, Action, and Transition',
      fontsize = 15
    ]
    node[
      fixedsize = false
    ]
      a1[label = '<I>s</I>@_{<I>i</I>}=<I>&sigma;</I>', shape = circle];
      a2[label = 'Which row\n to seat?', shape = square];
    edge[label = '<I>x@_{i}</I>'] a1 -> a2 ;
      a3[label = 'Dispatch\n or not?', shape = square];
    edge[label = ''] a2 -> a3;
      a4[label = '<I>s</I>@_{<I>i</I>+1}=<I>&sigma;</I>&prime;', shape = circle];
      edge[label = ''] a3 -> a4;

}
  "
)
```

We assume that the situation is stationary.
This stationarity assumption means that the probability of a group of size $k$ arriving is independent of time, i.e., $P[x_i=k]=p_k$ for all $i$.

## Simple case: Markov chain
For a single-row layout, only two actions are possible when a group arrives: seat the group in the remaining empty seats or dispatch the vehicle and seat them in a new vehicle. Row selection is not applicable since there is only one row.

In this single-row case with first-come-first-served seating, the state can be simplified to the number of filled seats.
If the row has $n$ seats, the state space becomes $\Sigma = \{0, 1, 2, \ldots, n\}$.
Each state $\sigma \in \Sigma$ represents the number of filled seats **immediately after a group has been seated and before the next group arrives**.
State $n$ (full occupancy) is included in the state space.
From this state, any arriving group triggers an immediate dispatch, since no seats remain available, and the group is seated in a new empty vehicle.
Thus $s_i \in \{0, 1, \ldots, n\}$ denotes the number of filled seats after the $i$-th group has been seated.

Since friend groups must sit together in the same row and cannot be split, groups of size $k > n$ cannot be seated in a single-row configuration.
Therefore, $p_k = 0$ for all $k > n$ is a necessary consequence of this physical constraint.

In this single-row case, our model can be treated as a simple **Markov chain model**.

### Stationary state probability distribution
Under mild conditions, a finite-state Markov chain converges to a unique stationary distribution.
For our model with finite state space $\Sigma = \{0, 1, \ldots, n\}$ and typical arrival distributions, these conditions are satisfied, guaranteeing the existence of a stationary state.

We define the **stationary state probability vector** as:
$$
\pi = (\pi_0, \pi_1, \ldots, \pi_{n})
$$
where $\pi_j = \lim_{i \to \infty} P[s_i = j]$ for $j \in \{0, 1, \ldots, n\}$ represents the long-run probability that exactly $j$ seats are filled when a grouping decision is made.

Given the arrival distribution $p_k = P[x_i=k]$, we can derive the stationary distribution $\pi$ through the three steps outlined below.
Once $\pi$ is obtained, we can calculate the expected seat occupancy, which represents the theoretical upper bound under the FIFO constraint.

### Steps to solve the problem
We solve this in three steps:

1. Construct a transition matrix based on the number of seats and the distribution of group sizes.
2. Identify the stationary state.
3. Calculate the expected seat occupancy from the stationary probability distribution.

#### Constructing a transition matrix
Suppose a group of size $k$ arrives.
If the number of empty seats is greater than or equal to $k$, the group is seated.
If it is less than $k$, the crew dispatches the current vehicle and the group is seated in a new vehicle.

- If $s_i + x_i \leq n$ then $s_{i+1}=s_i+x_i$ 
- If $s_i + x_i > n$ then $s_{i+1}=x_i$

This means the state probability can be described by the previous state and arrival distribution.
Since the arrival distribution is independent of the current state, the transition probabilities are
$$
\begin{eqnarray}
T_{jk}&=&P[s_{i+1}=k|s_{i}=j]\\
  &=& \sum_{x=1}^{n} p_x \left[ \mathbb{1}_ {[j+x=k, j+x \leq n]}
  + \mathbb{1}_ {[x=k, j+x > n]} \right]
\end{eqnarray}
$$
We call matrix $T$ the **transition matrix**.

We demonstrate an example with the simplest case: two seats.
In this case, the seat occupancy can be in states $s_i=0, 1, 2$.


Fig.2 shows the Markov states and transitions in this situation.
```{r twoseattransition, fig.width = 4}
grViz("
  digraph dot{
    graph[
      rankdir = LR,
      label = 'Fig.2: The Simplest Case (two seats). \nRed arrows indicate dispatch',
      fontsize = 10,
      layout = neato,
      ordering = out,
    ];
    node[
      shape = circle,
      fixedsize = true
    ];
    a0[label = '0'];
    a1[label = '1'];
    a2[label = '2'];
    a0 -> a1[label = '<I>p</I>@_{1}'];
    a0 -> a2[label = '<I>p</I>@_{2}'];
    a1 -> a2[label = '<I>p</I>@_{1}'];
    a1 -> a2[label = '<I>p</I>@_{2}', color = red];
    a2 -> a1[label = '<I>p</I>@_{1}', color = red];
    a2 -> a2[label = '<I>p</I>@_{2}', color = red];
  }
")
```
Since each element $T_{jk}$ represents the probability of moving from state $s_i=j$ to state $s_{i+1}=k$, we can define the transition matrix as
$$
T=\begin{pmatrix}
  0 & p_1 & p_2 \\
  0 & 0 & 1\\
  0 & p_1 & p_2
  \end{pmatrix},
$$
since $p_1+p_2=1$ for the two-seat case.

#### Stationary State
Let $\mathbf{p}^{(i)}$ denote the state probability distribution after $i$ transitions from an arbitrary initial distribution.
The evolution of the probability distribution follows:
$$
\mathbf{p}^{(i+1)} = \mathbf{p}^{(i)} T
$$
As $i \to \infty$, the distribution converges to the stationary distribution $\pi$, which satisfies:
$$
\pi = \pi T
$$
This means the stationary state $\pi$ is the left eigenvector corresponding to eigenvalue 1 of $T$.
We obtain the stationary state by calculating this eigenvector of $T$.

**Example: Two-seat case**

For the two-seat case introduced in Fig.2, we solve for the stationary distribution using the transition matrix:
$$
T=\begin{pmatrix}
0 & p_1 & p_2 \\
0 & 0 & 1\\
0 & p_1 & p_2
\end{pmatrix}
$$

From the eigenvector equation $\pi T=\pi$, we obtain the system:
$$
\begin{cases}
0 &=& \pi_0 \\
p_1(\pi_0 + \pi_2) &=& \pi_1 \\
p_2(\pi_0 + \pi_2) + \pi_1 &=& \pi_2
\end{cases}
$$

Solving this system with the normalization constraint $\pi_0 + \pi_1 + \pi_2 = 1$, we obtain:
$$
\pi = \begin{pmatrix}0 & \frac{p_1}{1+p_1} & \frac{1}{1+p_1}\end{pmatrix}
$$

Note that $\pi_0=0$ means that in the stationary state, the vehicle is never empty when a grouping decision is made, as guests arrive continuously.

#### Expected Seat Occupancy
Once the stationary distribution $\pi$ is obtained, we can calculate the expected seat occupancy rate.

When a vehicle is dispatched from state $s_i=j$, the number of occupied seats is $j$.
The dispatch occurs when the next arriving group of size $x_i$ cannot fit in the remaining seats, i.e., when $j + x_i > n$.

The probability of dispatch from state $j$ is:
$$
p_D(j) = \sum_{k=n-j+1}^{n} p_k
$$

The overall dispatch probability is:
$$
p_D = \sum_{j=0}^{n} \pi_j p_D(j)
$$

The expected occupancy rate is then:
$$
\mathrm{E}[Ocp] = \frac{1}{p_D} \sum_{j=0}^{n} \pi_j \cdot \frac{j}{n} \cdot p_D(j)
$$

**Example: Two-seat case (continued)**

Using the stationary distribution derived in the previous section, we calculate the dispatch probabilities from each state:

- From state 0: $p_D(0) = p_1 + p_2 = 1$ (always dispatch, but $\pi_0=0$ so no contribution)
- From state 1: $p_D(1) = p_2$ (dispatch only when a group of size 2 arrives)
- From state 2: $p_D(2) = p_1 + p_2 = 1$ (always dispatch)

The overall dispatch probability is:
$$
p_D = 0 \cdot 1 + \frac{p_1}{1+p_1} \cdot p_2 + \frac{1}{1+p_1} \cdot 1 = \frac{1 + p_1 p_2}{1+p_1}
$$

The expected occupancy rate is:
$$
\begin{eqnarray}
\mathrm{E}[Ocp] &=& \frac{1}{p_D}\left(\frac{1}{2} \cdot p_2 \cdot \frac{p_1}{1+p_1} + \frac{2}{2} \cdot 1 \cdot \frac{1}{1+p_1}\right) \quad (\text{since } \pi_0=0)\\
&=& \frac{1}{2p_D}\left(\frac{p_1(1-p_1)}{1+p_1} + \frac{2}{1+p_1}\right)\\
&=& \frac{p_1 - p_1^2 + 2}{2(1+p_1 - p_1^2)}
\end{eqnarray}
$$
Simplifying by substituting $p_2=1-p_1$ and the expression for $p_D$ from above.

For example, when $p_1 = 0.5$ (equal probability for single guests and pairs), the expected occupancy is:
$$
\mathrm{E}[Ocp] = 0.9
$$

Fig.3 shows how the expected occupancy varies with $p_1$ for the two-seat case.

```{r twoseatoccupancy, fig.width = 7, fig.height = 4}
library(ggplot2)

# Calculate expected occupancy as a function of p_1
p1 <- seq(0, 1, by = 0.01)
E_Ocp <- (p1 - p1^2 + 2) / (2 * (1 + p1 - p1^2))
df <- data.frame(p1 = p1, E_Ocp = E_Ocp)

# Create annotation data
annotation_df <- data.frame(
  p1 = c(0, 0.5, 1),
  E_Ocp = c(1, 0.9, 1),
  label = c("p[1]==0*': '*E*'[Ocp]=1'",
	    "p[1]==0.5*': '*E*'[Ocp]=0.9'",
	    "p[1]==1*': '*E*'[Ocp]=1'")
)

ggplot(df, aes(x = p1, y = E_Ocp)) +
  geom_line(color = "blue", linewidth = 1) +
  geom_hline(yintercept = 0.9, linetype = "dashed", color = "red", alpha = 0.5) +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red", alpha = 0.5) +
  geom_point(data = annotation_df, aes(x = p1, y = E_Ocp), color = c("darkgreen", "red", "darkgreen"), size = 3) +
  geom_text(data = annotation_df[2,], aes(label = label), parse = TRUE, hjust = 1, vjust = -0.5, size = 3.5) +
  labs(x = expression(p[1]), y = "Expected Occupancy Rate", title = "Fig.3: Expected Occupancy vs Single Guest Probability (Two-Seat Case)") +
  ylim(0.9, 1.0)
```

The plot reveals that the expected occupancy reaches its minimum value of 0.9 at $p_1=0.5$, and approaches 1.0 (perfect occupancy) at both extremes ($p_1 \to 0$ and $p_1 \to 1$).
This makes intuitive sense: when only one group size occurs ($p_1=0$ or $p_1=1$), all groups fit perfectly into the two-seat configuration.


## Practical Example: Single Row of Four Seats
As an example, we calculate seat occupancy in the following configuration:

- a single row of seats
- four seats per row

This situation matches the seat configuration of Harry Potter and the Forbidden Journey.

### State Space Definition
In the two-seat case analyzed earlier, we observed that the stationary probability of state 0 (completely empty vehicle) was $\pi_0=0$. 
This reflects the reality that under continuous guest arrivals in the stationary regime, we never observe a completely empty vehicle waiting for the next group.

Therefore, for the four-seat analysis, we exclude state 0 and define the state space as $\Sigma = \{1,2,3,4\}$, where each state represents the number of filled seats immediately after a group has been seated.

### Transition Matrix
With only a single row, guests must be seated in arrival order.
Therefore, the grouping strategy is determined automatically.

$$
T = \begin{pmatrix}
0 & p_1 & p_2 & p_3+p_4\\
0 & 0 & p_1 + p_3 & p_2+p_4\\
0 & p_2 & p_3 & p_1+p_4\\
p_1 & p_2 & p_3 & p_4
\end{pmatrix}
$$

### Stationary Distribution

For the general four-parameter model $(p_1, p_2, p_3, p_4)$ with $p_1 + p_2 + p_3 + p_4 = 1$, solving the eigenvector equation $\pi T = \pi$ yields:

$$
\pi = (\pi_1, \pi_2, \pi_3, \pi_4)
$$

where
$$
\begin{align}
\pi_1 &= \frac{p_1(-p_1 p_2 - p_2 p_3 - p_3 + 1)}{Z}\\
\pi_2 &= \frac{-p_1^2 p_3 + p_1^2 + p_1 p_2^2 + p_1 p_2 - p_2 p_3 + p_2 p_4 + p_2}{Z}\\
\pi_3 &= \frac{p_1^3 + p_1^2 p_3 + 2p_1 p_2 + p_1 + p_2 p_3 + p_4}{Z}\\
\pi_4 &= \frac{-p_1 p_2 - p_2 p_3 - p_3 + 1}{Z}
\end{align}
$$

and
$$
\begin{align}
Z = &\, p_1^3 - p_1^2 p_2 + p_1^2 + p_1 p_2^2 - p_1 p_2 p_3 + 2p_1 p_2 - p_1 p_3 + 2p_1\\
  &\, - p_2 p_3 + p_2 p_4 + p_2 - p_3 + p_4 + 1
\end{align}
$$

While this solution is exact, the complexity of the expressions makes analytical interpretation difficult.
To gain deeper insight into the relationship between arrival patterns and occupancy rates, we introduce a simplified single-parameter model later in this analysis.

### Dispatch Probability

For the general four-parameter model, the dispatch probability is calculated as:
$$
p_D = \sum_{j=1}^{4} \pi_j p_D(j)
$$
where $p_D(j)$ is the probability of dispatching the vehicle from state $j$:
- $p_D(1) = p_4$ (from state 1: dispatch if next group has size 4)
- $p_D(2) = p_3 + p_4$ (from state 2: dispatch if next group has size 3 or 4)
- $p_D(3) = p_2 + p_3 + p_4$ (from state 3: dispatch if next group has size 2, 3, or 4)
- $p_D(4) = 1$ (from state 4: always dispatch as vehicle is full)

Substituting the stationary distribution from above and using the constraint $p_1 + p_2 + p_3 + p_4 = 1$, we obtain:
$$
p_D = \frac{N_D}{Z}
$$
Both $N_D$ and $Z$ can be expressed as polynomials in $p_1$:
$$
N_D = a_0 + a_1 p_1 + a_2 p_1^2 + a_3 p_1^3
$$
where
$$
\begin{align}
a_3 &= p_2 + p_3 + p_4\\
a_2 &= p_2 p_3 - p_2 p_4 + p_3 + p_4\\
a_1 &= p_2^2 p_3 + p_2^2 p_4 + 2p_2^2 - p_2 p_3 p_4 + 3p_2 p_3 + 3p_2 p_4 - p_3 p_4 + p_3 + 2p_4\\
a_0 &= p_2^2 p_3 + p_2 p_3 p_4 + p_2 p_4^2 + 2p_2 p_4 + p_3 p_4 - p_3 + p_4^2 + 1
\end{align}
$$
and
$$
Z = b_0 + b_1 p_1 + b_2 p_1^2 + b_3 p_1^3
$$
where
$$
\begin{align}
b_3 &= 1\\
b_2 &= 1 - p_2\\
b_1 &= p_2^2 - p_2 p_3 + 2p_2 - p_3 + 2\\
b_0 &= -p_2 p_3 + p_2 p_4 + p_2 - p_3 + p_4 + 1
\end{align}
$$

The complexity of this expression motivates the introduction of a simplified single-parameter model for gaining analytical insight.

### Expected Occupancy
(to be analyzed)
 
### Single-Parameter Model

To obtain an explicit solution, we introduce a single-parameter model by setting $p_1=p$ and $p_2=p_3=p_4=(1-p)/3$.
This represents the simplest scenario where single guests arrive with probability $p$, and all multi-person groups (sizes 2, 3, 4) are equally likely, each with probability $(1-p)/3$.
Then from the equation $\pi T=\pi$, we can obtain the stationary state
$$
\pi = \frac{1}{6(p+1)(2p^2-p+2)}\begin{pmatrix}
  2p^2+2p+5\\
  2p^3+2p^2+5p\\
  4p^3+4p^2-2p+3\\
  6p^3-2p^2+p+4
  \end{pmatrix}
$$

The dispatch probability is
$$
p_D=\frac{-28p^4+24p^3+6p^2-8p+33}{18(p+1)(2p^2-p+2)}
$$

The expected occupancy rate is
$$
\begin{eqnarray}
\mathrm{E}[Ocp] &=& \frac{1}{p_D}\frac{3-2p}{4}\\
  &=& \frac{9(p+1)(3-2p)(2p^2-p+2)}{2(-28p^4+24p^3+6p^2-8p+33)}
  \end{eqnarray}
$$


We substitute concrete values into the parameters.
In case of $p=1/20$, 
$$
\pi = \begin{pmatrix}\pi_0 & \pi_1 & \pi_2 & \pi_3\end{pmatrix}= \begin{pmatrix}0.415 & 0.021 & 0.236 & 0.329\end{pmatrix}.
$$

To calculate the dispatch probability, we define the dispatch transition matrix $T_D$, which contains only the transition probabilities that result in vehicle dispatch:
$$
T_D = \begin{pmatrix}
  p_4&p_3+2p_4&p_2+2p_4&p_1+2p_4\\
  0&0&0&0\\
  0&0&0&p_2\\
  0&0&p_3&p_3
  \end{pmatrix}
$$
thus
$$
p_D = \pi T_D \mathbf{1}=0.8827
$$
Therefore, the expected occupancy is
$$
\mathrm{E}[Ocp] = \pi \begin{pmatrix}
  p_4 \\
  p_3+\frac54p_4\\
  p_2+\frac12p_3+\frac32p_4\\
  p_1+\frac34p_2+\frac34p_3+\frac74p_4\\
\end{pmatrix}
  =0.8213
$$

### Single-Rider Queue Case
A single-rider queue is a separate queue for guests arriving alone. This system allows single riders to bypass the main queue and fill remaining empty seats in vehicles that are about to be dispatched.
By separating single riders from the main queue, we can analyze the main queue occupancy independently and then account for the contribution of single riders.

In this analysis, we set $p_1=0$ for the main queue, as single riders use the dedicated queue.
The arrival probabilities for the main queue become:
$$
p_1=0, p_2=p_3=p_4=1/3.
$$

Then we can obtain the stationary state as:
$$
\pi=\begin{pmatrix}0.417 & 0 & 0.25 & 0.333\end{pmatrix}.
$$

Using this, we can easily calculate the dispatch probability
$$
p_D = 0.9167
$$
and the expected occupancy
$$
\mathrm{E}[Ocp]=0.818
$$

To obtain the overall expected occupancy, we account for single riders filling remaining empty seats.
If the proportion of available single riders is $p_s$ (assumed to be 0.05), the adjusted expected occupancy becomes:
$$
\mathrm{E}[Ocp_S]=\mathrm{E}[Ocp](1+p_s)=0.859
$$

### Pre-grouping Case

Pre-grouping is a strategy where we combine arriving groups before seating them.
For a four-seat configuration, we can consider three different pre-grouping strategies based on which group size to keep separate.

In this analysis, single riders (size 1) are handled separately through a dedicated single-rider queue, as described in the Single-Rider Queue Case above. Therefore, we focus on pre-grouping strategies for groups of sizes 2, 3, and 4, with the normalization $p_2 + p_3 + p_4 = 1$.

#### Case A: Separating Size-2 Groups
We keep groups of size 2 separate and merge groups of size 3 and 4 together.

When all arriving groups consist of exactly 2 guests (i.e., $p_2=1$), each vehicle is filled with two groups of size 2, resulting in perfect occupancy of 1.0.

For the case where only groups of size 3 or 4 arrive, we denote their probabilities as $p_3=p$ and $p_4=1-p$.

The state space is $\{3, 4\}$, representing the size of the waiting group. The transition matrix is:
$$
T = \begin{pmatrix}p & 1-p \\ p & 1-p\end{pmatrix}
$$

Stationary state:
$$
\pi = \begin{pmatrix}p & 1-p\end{pmatrix}
$$

Dispatch probability:
$$
p_D=1
$$

The expected occupancy for the merged queue (sizes 3 and 4 only) is:
$$
\mathrm{E}[Ocp_{3,4}]=\frac{4-p}{4}
$$

The overall expected occupancy, accounting for both queues, is:
$$
\mathrm{E}[Ocp] = p_2 \cdot 1 + (p_3 + p_4) \cdot \frac{4-p}{4} = p_2 + \frac{3}{4}p_3 + p_4
$$
where $p = \frac{p_3}{p_3+p_4}$.

For example, if $p_2=p_3=p_4=1/3$, then $p=1/2$ and:
$$
\mathrm{E}[Ocp] = \frac{1}{3} + \frac{3}{4} \cdot \frac{1}{3} + \frac{1}{3} = \frac{11}{12} \approx 0.917
$$


#### Case B: Separating Size-3 Groups
We keep groups of size 3 separate and merge groups of size 2 and 4 together.

When all arriving groups consist of exactly 3 guests (i.e., $p_3=1$), the expected occupancy is 0.75, since each vehicle always carries exactly 3 out of 4 seats filled.

For the case where only groups of size 2 or 4 arrive, we denote their probabilities as $p_2=p$ and $p_4=1-p$.

The state space is $\{2, 4\}$, representing the number of filled seats immediately after a group has been seated. The transition matrix is:
$$
T = \begin{pmatrix} 0 & 1 \\ p & 1-p\end{pmatrix}
$$

Stationary state:
$$
\pi = \frac{1}{1+p}\begin{pmatrix}p & 1\end{pmatrix}
$$

Dispatch probability:
$$
p_D=\frac{-p^2+p+1}{p+1}
$$

The expected occupancy for the merged queue (sizes 2 and 4 only) is:
$$
\mathrm{E}[Ocp_{2,4}]=\frac{-p^2+p+2}{2(-p^2+p+1)}
$$

The overall expected occupancy, accounting for both queues, is:
$$
\mathrm{E}[Ocp] = p_3 \cdot \frac{3}{4} + (p_2 + p_4) \cdot \mathrm{E}[Ocp_{2,4}]
$$
where $p=\frac{p_2}{p_2+p_4}$.

In the case $p=1/2$ (merged queue only), the expected occupancy reaches its minimum value of 0.9.

For example, if $p_2=p_3=p_4=1/3$, then $p=1/2$ and:
$$
\mathrm{E}[Ocp] = \frac{1}{3} \cdot \frac{3}{4} + \frac{2}{3} \cdot 0.9 = \frac{1}{4} + 0.6 = 0.85
$$

#### Case C: Separating Size-4 Groups
We keep groups of size 4 separate and merge groups of size 2 and 3 together.

When all arriving groups consist of exactly 4 guests (i.e., $p_4=1$), each vehicle is filled perfectly, resulting in occupancy of 1.0.

For the case where only groups of size 2 or 3 arrive, we denote their probabilities as $p_2=p$ and $p_3=1-p$.

The state space is $\{2, 3, 4\}$, representing the number of filled seats immediately after a group has been seated. The transition matrix is:
$$
T = \begin{pmatrix}
0 & 1-p & p \\
p & 1-p & 0 \\
p & 1-p & 0
\end{pmatrix}
$$

Stationary state:
$$
\pi = \begin{pmatrix}\frac{p}{1+p} & 1-p & \frac{p^2}{1+p}\end{pmatrix}
$$

Dispatch probability:
$$
p_D=\frac{1+p-p^2}{1+p}
$$

The expected occupancy for the merged queue (sizes 2 and 3 only) is:
$$
\mathrm{E}[Ocp_{2,3}]=\frac{3+2p-p^2}{4(1+p-p^2)}
$$

The overall expected occupancy, accounting for both queues, is:
$$
\mathrm{E}[Ocp] = p_4 \cdot 1 + (p_2+p_3) \cdot \mathrm{E}[Ocp_{2,3}]
$$
where $p = \frac{p_2}{p_2+p_3}$.

In the case $p=1/2$ (merged queue only), the expected occupancy is 0.75.

For example, if $p_2=p_3=p_4=1/3$, then $p=1/2$ and:
$$
\mathrm{E}[Ocp] = \frac{1}{3} \cdot 1 + \frac{2}{3} \cdot 0.75 = \frac{1}{3} + 0.5 = \frac{5}{6} \approx 0.833
$$

#### Comparison of Pre-grouping Strategies
We compare the expected occupancy rates across different queueing strategies for the four-seat configuration with $p_2=p_3=p_4=1/3$.

**Single Queue Case** ($p=0$ in the parameterization):
$$
\mathrm{E}[Ocp] = \frac{9}{11} \approx 0.818
$$

**Case A** (Separating Size-2):
$$
\mathrm{E}[Ocp] = \frac{11}{12} \approx 0.917
$$

**Case B** (Separating Size-3):
$$
\mathrm{E}[Ocp] = 0.85
$$

**Case C** (Separating Size-4):
$$
\mathrm{E}[Ocp] = \frac{5}{6} \approx 0.833
$$

**Analysis**: Among the three pre-grouping strategies, Case A achieves the highest expected occupancy (0.917), representing a substantial improvement of approximately 0.10 (or 12% relative improvement) over the Single Queue Case (0.818). Case B and Case C also outperform the Single Queue Case.

These results demonstrate that the choice of pre-grouping strategy significantly impacts seat occupancy. For attractions with similar group size distributions, implementing a pre-grouping system that separates size-2 groups can provide substantial operational benefits. The framework established here allows operators to evaluate the optimal pre-grouping strategy for any given group size distribution.

Note: These occupancy rates exclude single riders, who are handled through a separate queue. In practice, single riders can fill remaining empty seats, providing an additional improvement factor as shown in the Single-Rider Queue Case.


## Conclusion
